# Database Schema Documentation

## Overview
This document outlines the complete database schema for the HR Complaint Management System with AI Analytics integration.

**Database**: MongoDB Atlas
**Collections**: 4 primary collections
**Features**: LINE OA integration, tRPC APIs, AI sentiment analysis with Gemini

---

## Collections Summary

| Collection | Purpose | Key Features | AI Enhanced |
|------------|---------|--------------|-------------|
| `complaint_sessions` | Store complaint conversations | Embedded chat logs, LINE user mapping | ✅ Source for AI |
| `complaint_analytics` | AI analysis results | Sentiment, keywords, confidence scores | ✅ AI Generated |
| `employees` | Employee registry | LINE userId mapping, department info | ❌ Reference data |
| `line_events_raw` | LINE webhook audit | Raw webhook payloads for debugging | ❌ Audit logs |

**Note**: All schemas below exactly match the Mongoose models defined in `planning.md`

---

## Detailed Schema Definitions

### 1. complaint_sessions

**Purpose**: Primary storage for complaint conversations from LINE OA chat

// ChatLog Schema (embedded in ComplaintSession)
const ChatLogSchema = new mongoose.Schema({
  timestamp: { type: Date, required: true },
  direction: { type: String, enum: ['user', 'bot'], required: true },
  message_type: { type: String, enum: ['text', 'image', 'file', 'command'], required: true },
  message: { type: String, required: true }
}, { _id: false });

// Mongoose Schema (matches planning.md exactly)
const ComplaintSessionSchema = new mongoose.Schema({
  _id: { type: String, required: true },
  complaint_id: { type: String, required: true, unique: true },
  user_id: { type: String, required: true, index: true },
  status: { type: String, enum: ['open', 'submitted'], default: 'open', index: true },
  start_time: { type: Date, required: true },
  end_time: { type: Date },
  department: { type: String },
  chat_logs: { type: [ChatLogSchema], required: true },
  created_at: { type: Date, default: Date.now },
  updated_at: { type: Date, default: Date.now }
});

// Sample Document:
{
  _id: "sess_20250914_ABC123",
  complaint_id: "CMP-2025-09-14-0001",
  user_id: "Ucb71e2...1234",
  status: "submitted",
  start_time: ISODate("2025-09-14T10:02:34Z"),
  end_time: ISODate("2025-09-14T10:15:55Z"),
  department: "Operations",
  chat_logs: [
    {
      timestamp: ISODate("2025-09-14T10:02:35Z"),
      direction: "user",
      message_type: "command",
      message: "/complain"
    },
    {
      timestamp: ISODate("2025-09-14T10:02:37Z"),
      direction: "bot",
      message_type: "text",
      message: "Please describe your complaint. Type /submit when done."
    },
    {
      timestamp: ISODate("2025-09-14T10:06:12Z"),
      direction: "user",
      message_type: "text",
      message: "My manager repeatedly assigns unpaid overtime work."
    },
    {
      timestamp: ISODate("2025-09-14T10:15:10Z"),
      direction: "user",
      message_type: "command",
      message: "/submit"
    }
  ],
  created_at: ISODate("2025-09-14T10:02:34Z"),
  updated_at: ISODate("2025-09-14T10:15:55Z")
}
```

**Indexes**:
```javascript
// Primary queries
{ status: 1, start_time: -1 }           // Dashboard listing
{ user_id: 1, start_time: -1 }          // User's complaints
{ complaint_id: 1 }                     // Unique constraint & direct lookup
{ department: 1, start_time: -1 }       // Department filtering
```

**Size Considerations**:
- Typical conversation: ~5-20 messages = ~2-8KB
- Max recommended: ~500 messages per session
- If exceeded: Create new session or move to separate `chat_logs` collection

---

### 2. complaint_analytics (AI Enhanced)

**Purpose**: Store AI analysis results generated by Gemini API

// Mongoose Schema (matches planning.md exactly)
const ComplaintAnalyticsSchema = new mongoose.Schema({
  complaint_id: { type: String, required: true, unique: true, index: true },
  user_id: { type: String, required: true, index: true },
  sentiment: { type: String, enum: ['positive', 'negative', 'neutral'], required: true },
  confidence_score: { type: Number, min: 0, max: 1, required: true },
  tags_keywords: [{ type: String }],
  ai_model_version: { type: String, required: true },
  created_at: { type: Date, default: Date.now }
});

// Sample Document:
{
  complaint_id: "CMP-2025-09-14-0001",
  user_id: "Ucb71e2...1234",
  sentiment: "negative",
  confidence_score: 0.87,
  tags_keywords: [
    "management",
    "overtime",
    "unpaid work",
    "workplace abuse"
  ],
  ai_model_version: "gemini-1.5-flash",
  created_at: ISODate("2025-09-14T10:16:30Z")
}
```

**Indexes**:
```javascript
// Analytics dashboard queries
{ sentiment: 1, created_at: -1 }        // Sentiment trends
{ tags_keywords: 1 }                    // Keyword frequency
{ complaint_id: 1 }                     // Unique constraint
{ user_id: 1, created_at: -1 }          // User analytics
```

**AI Processing Flow**:
1. Complaint submitted (`status: "submitted"`)
2. Background job extracts user messages
3. Gemini API analyzes sentiment + keywords
4. Results saved to this collection
5. Dashboard displays analytics

---

### 3. employees

**Purpose**: Map LINE users to employee information

// Mongoose Schema (matches planning.md Employee interface)
const EmployeeSchema = new mongoose.Schema({
  _id: { type: String, required: true },  // LINE userId
  display_name: { type: String, required: true },
  department: { type: String },  // Optional
  active: { type: Boolean, required: true },
  created_at: { type: Date, default: Date.now },
  updated_at: { type: Date, default: Date.now }
});

// Sample Document:
{
  _id: "Ucb71e2...1234",
  display_name: "N. Aungsirikul",
  department: "Operations",
  active: true,
  created_at: ISODate("2025-09-14T09:00:00Z"),
  updated_at: ISODate("2025-09-14T09:00:00Z")
}

**Indexes**:
```javascript
{ department: 1 }                       // Department filtering
{ active: 1 }                          // Active employees only
```

**Data Sources**:
- Manual entry via admin interface
- HR system integration (future)
- Self-registration via LINE bot (future)

---

### 4. line_events_raw (Audit & Debug)

**Purpose**: Store raw LINE webhook events for debugging and audit

```javascript
{
  _id: "evt_01J7XYZ123",
  received_at: ISODate("2025-09-14T10:02:34Z"),
  user_id: "Ucb71e2...1234",                     // Extracted from payload
  event_type: "message",                         // LINE event type
  payload: {                                     // Original webhook data
    "destination": "Uab12345...",
    "events": [{
      "type": "message",
      "mode": "active",
      "timestamp": 1726308154000,
      "source": {
        "type": "user",
        "userId": "Ucb71e2...1234"
      },
      "message": {
        "id": "464654654654",
        "type": "text",
        "text": "/complain"
      },
      "replyToken": "abc123def456..."
    }]
  }
}
```

**TTL Index** (Auto-cleanup):
```javascript
{ received_at: 1 }, { expireAfterSeconds: 5184000 }  // 60 days
```

---

## Data Flow & Relationships

### Primary Flow: Complaint Submission
```
1. LINE User sends /complain
   ↓
2. line_events_raw ← Raw webhook stored
   ↓
3. complaint_sessions ← New session created
   ↓
4. User sends messages ← Chat logs appended
   ↓
5. User sends /submit ← Session marked as "submitted"
   ↓
6. Background AI Processing
   ↓
7. complaint_analytics ← Gemini analysis stored
```

### Dashboard Queries Flow
```
HR Dashboard Request
   ↓
tRPC API (type-safe)
   ↓
MongoDB Aggregation Pipeline
   ↓
Real-time Analytics Response
```

---

## Query Patterns & Performance

### Dashboard Complaints List
```javascript
// Most common query - optimized with compound index
db.complaint_sessions.find({ status: "submitted" })
  .sort({ start_time: -1 })
  .limit(50)
  .project({
    complaint_id: 1,
    user_id: 1,
    department: 1,
    start_time: 1
  })
```

### Sentiment Analytics
```javascript
// Real-time sentiment distribution
db.complaint_analytics.aggregate([
  { $group: { _id: "$sentiment", count: { $sum: 1 } } }
])
```

### Word Cloud Data
```javascript
// Top complaint keywords
db.complaint_analytics.aggregate([
  { $unwind: "$tags_keywords" },
  { $group: { _id: "$tags_keywords", value: { $sum: 1 } } },
  { $sort: { value: -1 } },
  { $limit: 30 }
])
```

### User Complaint History
```javascript
// Individual user's complaints with AI insights
db.complaint_sessions.aggregate([
  { $match: { user_id: "Ucb71e2...1234" } },
  { $lookup: {
      from: "complaint_analytics",
      localField: "complaint_id",
      foreignField: "complaint_id",
      as: "analytics"
  }},
  { $sort: { start_time: -1 } }
])
```

---

## Data Validation & Constraints

### Mongoose Schema Validation
```javascript
// complaint_sessions validation
{
  $jsonSchema: {
    required: ["_id", "complaint_id", "user_id", "status", "start_time", "chat_logs"],
    properties: {
      status: { enum: ["open", "submitted"] },
      chat_logs: {
        minItems: 1,
        items: {
          properties: {
            direction: { enum: ["user", "bot"] },
            message_type: { enum: ["text", "image", "file", "command"] }
          }
        }
      }
    }
  }
}

// complaint_analytics validation
{
  $jsonSchema: {
    required: ["complaint_id", "user_id", "sentiment", "confidence_score", "tags_keywords"],
    properties: {
      sentiment: { enum: ["positive", "negative", "neutral"] },
      confidence_score: { minimum: 0, maximum: 1 },
      tags_keywords: {
        type: "array",
        minItems: 1,
        maxItems: 10,
        items: { type: "string", minLength: 2 }
      }
    }
  }
}
```

---

## Backup & Maintenance

### Data Retention Policies
- **complaint_sessions**: 7 years (regulatory compliance)
- **complaint_analytics**: 7 years (matches complaints)
- **employees**: Keep while active + 1 year
- **line_events_raw**: 60 days (TTL auto-cleanup)

### Backup Strategy
- **Daily**: Automated MongoDB Atlas backups
- **Monthly**: Export complaint data for long-term archival
- **Point-in-time**: Available for 24 hours

### Index Maintenance
- **Monthly**: Review index usage statistics
- **Quarterly**: Optimize based on query patterns
- **Annually**: Archive old data if volume becomes excessive

---

## Security & Privacy

### Data Protection
- **Encryption at Rest**: MongoDB Atlas encryption enabled
- **Field-level Encryption**: Consider for sensitive chat messages
- **Access Control**: Database user with minimum required permissions
- **Network Security**: Private VPC, no public access

### PII Handling
- **LINE User IDs**: Pseudonymous identifiers (not directly PII)
- **Display Names**: Store only what's necessary for HR identification
- **Chat Content**: Contains employee complaints (handle as confidential)
- **AI Analytics**: Derived data, same protection level as source

### GDPR Compliance
- **Right to be Forgotten**: Ability to delete user's data
- **Data Portability**: Export user's complaint history
- **Consent**: Employees aware of AI analysis
- **Purpose Limitation**: Data used only for HR complaint management

---

## Scaling Considerations

### Current Capacity (Small-Medium Organization)
- **Users**: 500-1000 employees
- **Complaints**: 100-500 per month
- **Storage**: ~10GB per year
- **Analytics**: Real-time processing sufficient

### Growth Planning (Large Organization)
- **Horizontal Scaling**: MongoDB Atlas auto-scaling
- **Read Replicas**: Separate analytics queries from transactional
- **Data Archiving**: Move old complaints to cold storage
- **Background Processing**: Queue-based AI analysis for high volume

### Performance Monitoring
- **Query Performance**: Monitor slow queries
- **Index Efficiency**: Track index hit ratios
- **AI Processing Time**: Gemini API response times
- **Dashboard Load Times**: Frontend performance metrics